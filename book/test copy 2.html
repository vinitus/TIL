<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>함수형 코딩 예제</title>
  </head>
  <body>
    <button id="cnt">cnt</button>
    <div style="margin-top: 10px">
      <div id="total1" style="font-size: 20px; border: 1px solid black; display: inline; padding: 2px 4px">1</div>
      <div id="total2" style="font-size: 20px; border: 1px solid black; display: inline; padding: 2px 4px">1</div>
    </div>
    <script>
      let cnt = 2;
      let prev = 1;

      async function fetchNum() {
        const date = new Date();
        const addNumber = Number(date.getMilliseconds());
        const multiplyNumber = Number(date.getSeconds());
        prev = calc(prev, addNumber, multiplyNumber);
        console.log(cnt === 2 ? `1번째시도 ${prev}` : `2번째시도 ${prev}`);

        tag2UpdateFn(addNumber, multiplyNumber);

        const res = await new Promise((resolve) => {
          if (cnt > 0) cnt -= 1;

          setTimeout(() => {
            resolve({ addNumber, multiplyNumber });
          }, cnt * 500);
        });

        return res;
      }

      function calc(n, a, b) {
        return (n + a) * b;
      }

      function tag2UpdateFn(a, b) {
        const div = document.querySelector('#total2');
        const originData = Number(div.innerText);
        div.innerText = calc(originData, a, b);
      }

      function makeWorker() {
        console.log('worker on');
        const workQueue = [];
        let workingFlag = false;

        function worker() {
          console.log('worker');
          if (workingFlag) return;
          if (workQueue.length === 0) return;

          const work = workQueue.shift();
          const { callback, value } = work;

          if (callback instanceof Promise) console.log('hi');
          work.value = callback();
          console.log(work.value);
        }

        return () => {
          workQueue.push({
            callback: fetchNum,
            value: null,
          });
          worker();
        };
      }

      function print(arg, a) {
        let result = '';

        for (const item of arg) {
          result += item.addNumber + ' ';
          result += item.multiplyNumber + ' ';
        }

        console.log(result + ' ' + a);
      }

      const worker = makeWorker();

      const btn = document.querySelector('#cnt');

      btn.addEventListener('click', worker);
    </script>
  </body>
</html>
